<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1. Elasticsearch &mdash; SRE运维 v0.0.1 文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=7cf98a4c"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/translations.js?v=beaddf03"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="1. Kubernetes 基础" href="../kubernetes.html" />
    <link rel="prev" title="&lt;no title&gt;" href="../../index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SRE运维
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">日志采集</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. Elasticsearch</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">1.1. 安装</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">1.1.1. 单点安装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">1.1.2. 集群安装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">1.1.3. 启动失败解决方案</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cerebro">1.1.4. Cerebro 管理程序</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id5">1.2. 基础</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">1.2.1. Elasticsearch相关术语</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">1.2.2. 索引相关操作</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">1.2.2.1. 创建索引</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">1.2.2.2. 修改索引</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">1.2.2.3. 查看索引</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">1.2.2.4. 删除索引</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">1.2.2.5. 索引别名</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">1.2.2.6. 关闭索引</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">1.2.2.7. 打开索引</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">1.2.2.8. 索引模板</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id16">1.2.3. 文档基础操作</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id17">1.2.3.1. 创建文档</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">1.2.3.2. 文档修改</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">1.2.3.3. 文档查看</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">1.2.3.4. 删除文档</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">1.2.3.5. 批量操作</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#mapping">1.2.4. Mapping配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id22">1.2.5. 分词器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#standard">1.2.5.1. standard 分词器</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ik">1.2.5.2. IK分词器</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dsl">1.2.6. DSL语句</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id23">1.2.6.1. 准备数据</a></li>
<li class="toctree-l4"><a class="reference internal" href="#match">1.2.6.2. 全文检索-match</a></li>
<li class="toctree-l4"><a class="reference internal" href="#match-phrase">1.2.6.3. 精确匹配-match_phrase</a></li>
<li class="toctree-l4"><a class="reference internal" href="#match-all">1.2.6.4. 全量查询-match_all</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id24">1.2.6.5. 分页查询</a></li>
<li class="toctree-l4"><a class="reference internal" href="#source">1.2.6.6. 查看的指定字段-<code class="docutils literal notranslate"><span class="pre">_source</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#exists">1.2.6.7. 查询存在某个字段的文档-exists</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id25">1.2.6.8. 语法高亮</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id26">1.2.6.9. 排序查询</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bool">1.2.6.10. 多条件查询-bool</a></li>
<li class="toctree-l4"><a class="reference internal" href="#filter">1.2.6.11. 过滤查询-filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="#terms">1.2.6.12. 精确匹配多个值-terms</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id27">1.2.6.13. 多词搜索</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id28">1.2.6.14. 权重查询</a></li>
<li class="toctree-l4"><a class="reference internal" href="#aggs">1.2.6.15. 聚合查询-aggs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id29">1.3. 进阶</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#api">1.3.1. 集群常用API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#reindex">1.3.1.1. 集群迁移-reindex</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id30">1.3.1.2. 集群状态</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id31">1.3.1.3. 集群的分片情况</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id32">1.3.1.4. 集群分片重路由</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id33">1.3.1.5. 集群配置优先级</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id34">1.3.2. 集群角色</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id35">1.3.3. 文档写入流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id36">1.3.4. 文档读取流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id37">1.3.5. 底层存储原理</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#kibana">2. Kibana</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id38">2.1. 安装</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#filebeat">3. FileBeat</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id39">3.1. 安装</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#rpm">3.1.1. rpm 包安装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id40">3.1.2. 预编译二进制包安装</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id41">3.2. 配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#input">3.2.1. Input 插件</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#tcp">3.2.1.1. Tcp插件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#log">3.2.1.2. Log插件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id42">3.2.1.3. Input通用字段</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nginx">3.2.1.4. 采集Nginx日志</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tomcat">3.2.1.5. 采集Tomcat日志</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ouput">3.2.2. Ouput 插件</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">云原生</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../kubernetes.html">1. Kubernetes 基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kubernetes.html#id1">2. Kubernetes 进阶</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SRE运维</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">1. </span>Elasticsearch</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/post/elk/elasticstack.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="elasticsearch">
<h1><span class="section-number">1. </span>Elasticsearch<a class="headerlink" href="#elasticsearch" title="Link to this heading"></a></h1>
<!-- > <https://github.com/tchapi/markdown-cheatsheet> --><hr class="docutils" />
<p>elasticsearch 是一个高度可扩展的开源全文搜索和分析引擎，它可实现数据的实时全文搜索、支持分布式可实现高可用、提供 API 接口，可以处理大规模日志数据，比如 Nginx、Tomcat、系统日志等功能。Elasticsearch 使用 Java 语言开发，是建立在全文搜索引擎 Apache Lucene 基础之上的搜索引擎。</p>
<p>Elasticsearch 的特点</p>
<ul class="simple">
<li><p>实时搜索、实时分析</p></li>
<li><p>分布式架构、实时文件存储</p></li>
<li><p>文档导向，所有对象都是文档</p></li>
<li><p>高可用，易扩展，支持集群，分片与复制</p></li>
<li><p>接口友好，支持 json</p></li>
</ul>
<section id="id1">
<h2><span class="section-number">1.1. </span>安装<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<section id="id2">
<h3><span class="section-number">1.1.1. </span>单点安装<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<p><strong>rpm 安装</strong></p>
<ul class="simple">
<li><p>下载软件包</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="o">.</span><span class="n">tuna</span><span class="o">.</span><span class="n">tsinghua</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">elasticstack</span><span class="o">/</span><span class="mf">7.</span><span class="n">x</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="mf">7.17.5</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
</pre></div>
</div>
<ul class="simple">
<li><p>安装</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">localinstall</span> <span class="o">-</span><span class="n">y</span> <span class="o">./</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span> 
</pre></div>
</div>
<ul class="simple">
<li><p>准备日志目录和数据目录</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">install</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">es7</span><span class="o">/</span><span class="p">{</span><span class="n">data</span><span class="p">,</span><span class="n">logs</span><span class="p">}</span> <span class="o">-</span><span class="n">o</span> <span class="n">elasticsearch</span> <span class="o">-</span><span class="n">g</span> <span class="n">elasticsearch</span>
</pre></div>
</div>
<ul class="simple">
<li><p>配置</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">.</span><span class="n">yml</span>
<span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span>
<span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">es7</span><span class="o">/</span><span class="n">data</span>
<span class="n">path</span><span class="o">.</span><span class="n">logs</span><span class="p">:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">es7</span><span class="o">/</span><span class="n">logs</span>
<span class="n">network</span><span class="o">.</span><span class="n">host</span><span class="p">:</span> <span class="mf">192.168.122.135</span>
<span class="n">discovery</span><span class="o">.</span><span class="n">seed_hosts</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;elk1.linux.io&quot;</span><span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>启动服务</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span>  <span class="n">enable</span> <span class="n">elasticsearch</span> <span class="o">--</span><span class="n">now</span>
</pre></div>
</div>
<ul class="simple">
<li><p>验证</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span>
<span class="p">{</span>
  <span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;elk1.linux.io&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cluster_name&quot;</span> <span class="p">:</span> <span class="s2">&quot;elasticsearch&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cluster_uuid&quot;</span> <span class="p">:</span> <span class="s2">&quot;lO8uc1IrQAyBKR5579r8OA&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;number&quot;</span> <span class="p">:</span> <span class="s2">&quot;7.17.5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_flavor&quot;</span> <span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;rpm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_hash&quot;</span> <span class="p">:</span> <span class="s2">&quot;8d61b4f7ddf931f219e3745f295ed2bbc50c8e84&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_date&quot;</span> <span class="p">:</span> <span class="s2">&quot;2022-06-23T21:57:28.736740635Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_snapshot&quot;</span> <span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;lucene_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;8.11.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;minimum_wire_compatibility_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;6.8.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;minimum_index_compatibility_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;6.0.0-beta1&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;tagline&quot;</span> <span class="p">:</span> <span class="s2">&quot;You Know, for Search&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>预编译二进制安装</strong></p>
<ul class="simple">
<li><p>下载软件包</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">artifacts</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span><span class="o">/</span><span class="n">downloads</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>
</div>
<ul class="simple">
<li><p>解压</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tar</span> <span class="o">-</span><span class="n">xf</span> <span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>  <span class="o">-</span><span class="n">C</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span> 
<span class="n">ln</span> <span class="o">-</span><span class="n">sv</span> <span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">/</span> <span class="n">elasticsearch</span>
</pre></div>
</div>
<ul class="simple">
<li><p>准备日志目录和数据目录</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">useradd</span>   <span class="n">elastic</span>
<span class="n">install</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="p">{</span><span class="n">data</span><span class="p">,</span><span class="n">logs</span><span class="p">}</span> <span class="o">-</span><span class="n">o</span> <span class="n">elastic</span> <span class="o">-</span><span class="n">g</span> <span class="n">elastic</span>
</pre></div>
</div>
<ul class="simple">
<li><p>配置</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vim</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">.</span><span class="n">yml</span> 
<span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">elk2</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span>
<span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">data</span>
<span class="n">path</span><span class="o">.</span><span class="n">logs</span><span class="p">:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">logs</span>
<span class="n">network</span><span class="o">.</span><span class="n">host</span><span class="p">:</span> <span class="mf">192.168.122.136</span>
<span class="n">discovery</span><span class="o">.</span><span class="n">seed_hosts</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;elk2.linux.io&quot;</span><span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>启动服务</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">elastic</span><span class="o">.</span><span class="n">elastic</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span> 
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">elastic</span><span class="o">.</span><span class="n">elastic</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">/</span>
<span class="n">su</span> <span class="o">-</span> <span class="n">elastic</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;/data/apps/elasticsearch-7.17.5/bin/elasticsearch -d&#39;</span>  
</pre></div>
</div>
<ul class="simple">
<li><p>验证</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">elk2</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span>
<span class="p">{</span>
  <span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;elk2.linux.io&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cluster_name&quot;</span> <span class="p">:</span> <span class="s2">&quot;elasticsearch&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cluster_uuid&quot;</span> <span class="p">:</span> <span class="s2">&quot;Dw5L0Fb5Ska6RomQhspT2Q&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;number&quot;</span> <span class="p">:</span> <span class="s2">&quot;7.17.5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_flavor&quot;</span> <span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;tar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_hash&quot;</span> <span class="p">:</span> <span class="s2">&quot;8d61b4f7ddf931f219e3745f295ed2bbc50c8e84&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_date&quot;</span> <span class="p">:</span> <span class="s2">&quot;2022-06-23T21:57:28.736740635Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_snapshot&quot;</span> <span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;lucene_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;8.11.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;minimum_wire_compatibility_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;6.8.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;minimum_index_compatibility_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;6.0.0-beta1&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;tagline&quot;</span> <span class="p">:</span> <span class="s2">&quot;You Know, for Search&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id3">
<h3><span class="section-number">1.1.2. </span>集群安装<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th>主机名</th>
<th>IP 地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>elk1.linux.io</td>
<td>192.168.122.135</td>
</tr>
<tr>
<td>elk2.linux.io</td>
<td>192.168.122.136</td>
</tr>
<tr>
<td>elk3.linux.io</td>
<td>192.168.122.137</td>
</tr>
</tbody>
</table><ul class="simple">
<li><p>主机名解析</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span> <span class="o">&lt;&lt;</span><span class="s1">&#39;EOF&#39;</span>
<span class="mf">192.168.122.135</span> <span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span>
<span class="mf">192.168.122.136</span> <span class="n">elk2</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span>
<span class="mf">192.168.122.137</span> <span class="n">elk3</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span>
<span class="n">EOF</span>
</pre></div>
</div>
<ul class="simple">
<li><p>所有节点针对ES基础调优</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">limits</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">es7</span><span class="o">.</span><span class="n">conf</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span>
<span class="o">*</span>       <span class="n">soft</span>    <span class="n">nofile</span>  <span class="mi">65535</span>
<span class="o">*</span>       <span class="n">hard</span>    <span class="n">nofile</span>  <span class="mi">131070</span>
<span class="o">*</span>       <span class="n">hard</span>    <span class="n">nproc</span>   <span class="mi">8192</span>
<span class="n">EOF</span>

<span class="n">echo</span>  <span class="s2">&quot;vm.max_map_count=524288&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">es</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<ul class="simple">
<li><p>所有节点解压安装包</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tar</span> <span class="o">-</span><span class="n">xf</span> <span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>  <span class="o">-</span><span class="n">C</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span>
</pre></div>
</div>
<ul class="simple">
<li><p>所有节点创建运行ES服务的用户和数据目录</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">useradd</span>  <span class="n">elastic</span>
<span class="n">install</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">/</span><span class="p">{</span><span class="n">data</span><span class="p">,</span><span class="n">logs</span><span class="p">}</span> <span class="o">-</span><span class="n">o</span> <span class="n">elastic</span> <span class="o">-</span><span class="n">g</span> <span class="n">elastic</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">elastic</span><span class="o">.</span><span class="n">elastic</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span>
</pre></div>
</div>
<ul class="simple">
<li><p>配置</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vim</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">.</span><span class="n">yml</span> 
<span class="n">cluster</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">dev</span><span class="o">-</span><span class="n">es7</span><span class="o">-</span><span class="n">cluster</span> <span class="c1"># 所有节点保持一致</span>
<span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span> <span class="c1"># 修改为各自的主机名</span>
<span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">/</span><span class="n">data</span>
<span class="n">path</span><span class="o">.</span><span class="n">logs</span><span class="p">:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">/</span><span class="n">logs</span>
<span class="n">network</span><span class="o">.</span><span class="n">host</span><span class="p">:</span> <span class="mf">0.0.0.0</span> <span class="c1"># 如果有多块网卡，请明确指定IP</span>
<span class="n">discovery</span><span class="o">.</span><span class="n">seed_hosts</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;elk1.linux.io&quot;</span><span class="p">,</span> <span class="s2">&quot;elk2.linux.io&quot;</span><span class="p">,</span> <span class="s2">&quot;elk3.linux.io&quot;</span><span class="p">]</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">initial_master_nodes</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;elk1.linux.io&quot;</span><span class="p">,</span> <span class="s2">&quot;elk2.linux.io&quot;</span><span class="p">,</span> <span class="s2">&quot;elk3.linux.io&quot;</span><span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>使用Unit风格管理服务</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">es7</span><span class="o">.</span><span class="n">service</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span>
<span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">dev</span> <span class="n">service</span> <span class="n">es7</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Type</span><span class="o">=</span><span class="n">simple</span>
<span class="n">Environment</span><span class="o">=</span><span class="n">ES_HOME</span><span class="o">=/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">/</span><span class="n">jdk</span><span class="o">/</span>
<span class="n">Environment</span><span class="o">=</span><span class="n">ES_PATH_CONF</span><span class="o">=</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">/</span><span class="n">config</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">elasticsearch</span>
<span class="n">User</span><span class="o">=</span><span class="n">elastic</span>
<span class="n">Group</span><span class="o">=</span><span class="n">elastic</span>
<span class="n">LimitNOFILE</span><span class="o">=</span><span class="mi">131070</span>
<span class="n">LimitNPROC</span><span class="o">=</span><span class="mi">4096</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
<span class="n">EOF</span>
<span class="n">systemctl</span>  <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">systemctl</span>  <span class="n">enable</span> <span class="n">es7</span> <span class="o">--</span><span class="n">now</span>
</pre></div>
</div>
<ul class="simple">
<li><p>验证</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">elk2</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span>
<span class="p">{</span>
  <span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;elk2.linux.io&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cluster_name&quot;</span> <span class="p">:</span> <span class="s2">&quot;dev-es7-cluster&quot;</span><span class="p">,</span>  <span class="c1"># </span>
  <span class="s2">&quot;cluster_uuid&quot;</span> <span class="p">:</span> <span class="s2">&quot;0Efxhjq_S5uddZfIPLXLqQ&quot;</span><span class="p">,</span> <span class="c1"># 确保所有节点都一致</span>
  <span class="s2">&quot;version&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;number&quot;</span> <span class="p">:</span> <span class="s2">&quot;7.17.5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_flavor&quot;</span> <span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;tar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_hash&quot;</span> <span class="p">:</span> <span class="s2">&quot;8d61b4f7ddf931f219e3745f295ed2bbc50c8e84&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_date&quot;</span> <span class="p">:</span> <span class="s2">&quot;2022-06-23T21:57:28.736740635Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_snapshot&quot;</span> <span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;lucene_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;8.11.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;minimum_wire_compatibility_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;6.8.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;minimum_index_compatibility_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;6.0.0-beta1&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;tagline&quot;</span> <span class="p">:</span> <span class="s2">&quot;You Know, for Search&quot;</span>
<span class="p">}</span>
<span class="n">curl</span> <span class="n">elk2</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cat</span><span class="o">/</span><span class="n">nodes</span>
<span class="mf">192.168.122.137</span> <span class="mi">42</span> <span class="mi">96</span>  <span class="mi">0</span> <span class="mf">0.02</span> <span class="mf">0.07</span> <span class="mf">0.15</span> <span class="n">cdfhilmrstw</span> <span class="o">*</span> <span class="n">elk3</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span>
<span class="mf">192.168.122.136</span> <span class="mi">20</span> <span class="mi">91</span>  <span class="mi">8</span> <span class="mf">0.21</span> <span class="mf">0.24</span> <span class="mf">0.33</span> <span class="n">cdfhilmrstw</span> <span class="o">-</span> <span class="n">elk2</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span>
<span class="mf">192.168.122.135</span>  <span class="mi">7</span> <span class="mi">97</span> <span class="mi">10</span> <span class="mf">0.21</span> <span class="mf">0.39</span> <span class="mf">0.74</span> <span class="n">cdfhilmrstw</span> <span class="o">-</span> <span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span>
</pre></div>
</div>
</section>
<section id="id4">
<h3><span class="section-number">1.1.3. </span>启动失败解决方案<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>报错：<code class="docutils literal notranslate"><span class="pre">max</span> <span class="pre">file</span> <span class="pre">descriptors</span> <span class="pre">[4096]</span> <span class="pre">for</span> <span class="pre">elasticsearch</span> <span class="pre">process</span> <span class="pre">is</span> <span class="pre">too</span> <span class="pre">low,</span> <span class="pre">increase</span> <span class="pre">to</span> <span class="pre">at</span> <span class="pre">least</span> <span class="pre">[65535]</span></code></p></li>
<li><p>解决方案：修改文件打开数量上线，修改后需要断开会话</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">limits</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">es7</span><span class="o">.</span><span class="n">conf</span>
<span class="o">*</span>	<span class="n">soft</span>	<span class="n">nofile</span>	<span class="mi">65535</span>
<span class="o">*</span>	<span class="n">hard</span>	<span class="n">nofile</span>	<span class="mi">131070</span>
<span class="o">*</span>	<span class="n">hard</span>	<span class="n">nproc</span>	<span class="mi">8192</span>

<span class="n">ulimit</span> <span class="o">-</span><span class="n">Sn</span>
<span class="mi">65535</span>
<span class="n">ulimit</span> <span class="o">-</span><span class="n">Hn</span>
<span class="mi">131070</span>
</pre></div>
</div>
<ul class="simple">
<li><p>报错： <code class="docutils literal notranslate"><span class="pre">max</span> <span class="pre">virtual</span> <span class="pre">memory</span> <span class="pre">areas</span> <span class="pre">vm.max_map_count</span> <span class="pre">[65530]</span> <span class="pre">is</span> <span class="pre">too</span> <span class="pre">low,</span> <span class="pre">increase</span> <span class="pre">to</span> <span class="pre">at</span> <span class="pre">least</span> <span class="pre">[262144]</span></code></p></li>
<li><p>解决方案： 调大内核虚拟内存映射值</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">es</span><span class="o">.</span><span class="n">conf</span>
<span class="n">vm</span><span class="o">.</span><span class="n">max_map_count</span><span class="o">=</span><span class="mi">524288</span>

<span class="n">sysctl</span> <span class="o">-</span><span class="n">f</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">es</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sysctl</span> <span class="o">-</span><span class="n">q</span> <span class="n">vm</span><span class="o">.</span><span class="n">max_map_count</span>      
<span class="n">vm</span><span class="o">.</span><span class="n">max_map_count</span> <span class="o">=</span> <span class="mi">524288</span>
</pre></div>
</div>
<ul class="simple">
<li><p>报错：<code class="docutils literal notranslate"><span class="pre">java.net.UnknownHostException:</span> <span class="pre">elk2.linux.io</span></code></p></li>
<li><p>解决办法：hosts文件主机名添加解析</p></li>
<li><p>报错：<code class="docutils literal notranslate"><span class="pre">&quot;cluster_uuid&quot;</span> <span class="pre">:</span> <span class="pre">&quot;_na_&quot;,</span></code></p></li>
<li><p>解决办法：停止进程，然后删除脏数据，添加配置 cluster.initial_master_nodes，重新启动服务</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 删除脏数据，可不操作，仅适用于新集群</span>
<span class="n">pkill</span> <span class="o">-</span><span class="mi">9</span> <span class="n">java</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="p">{</span><span class="n">data</span><span class="o">/*</span><span class="p">,</span><span class="n">logs</span><span class="o">/*</span><span class="p">}</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">initial_master_nodes</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;elk2.linux.io&quot;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="cerebro">
<h3><span class="section-number">1.1.4. </span>Cerebro 管理程序<a class="headerlink" href="#cerebro" title="Link to this heading"></a></h3>
<blockquote>
<div><p>官网： https://github.com/lmenezes/cerebro</p>
</div></blockquote>
<p>Cerebro 是一个开源的elsticsearch web 管理工具 ，需要 java1.8 或者更高版本。</p>
<ul class="simple">
<li><p>下载</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">lmenezes</span><span class="o">/</span><span class="n">cerebro</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">v0</span><span class="mf">.8.1</span><span class="o">/</span><span class="n">cerebro</span><span class="o">-</span><span class="mf">0.8.1</span><span class="o">.</span><span class="n">tgz</span>
</pre></div>
</div>
<ul class="simple">
<li><p>安装</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">tar</span> <span class="o">-</span><span class="n">xf</span> <span class="n">cerebro</span><span class="o">-</span><span class="mf">0.8.1</span><span class="o">.</span><span class="n">tgz</span> <span class="o">-</span><span class="n">C</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span>
</pre></div>
</div>
<ul class="simple">
<li><p>配置</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">cd</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">cerebro</span><span class="o">-</span><span class="mf">0.8.1</span><span class="o">/</span>
<span class="n">vim</span> <span class="n">conf</span><span class="o">/</span><span class="n">application</span><span class="o">.</span><span class="n">conf</span> 
<span class="s1">&#39;&#39;&#39;</span>
<span class="s1">auth = {</span>
<span class="s1">  type: basic</span>
<span class="s1">    settings: {</span>
<span class="s1">      username = &quot;admin&quot;</span>
<span class="s1">      password = &quot;1234&quot;</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">...</span>
<span class="s1">hosts = [</span>
<span class="s1">  {</span>
<span class="s1">    host = &quot;http://192.168.122.135:9200&quot;</span>
<span class="s1">    name = &quot;dev-es7-cluster&quot;</span>
<span class="s1">  #  headers-whitelist = [ &quot;x-proxy-user&quot;, &quot;x-proxy-roles&quot;, &quot;X-Forwarded-For&quot; ]</span>
<span class="s1">  }</span>
<span class="s1">  # Example of host with authentication</span>
<span class="s1">  #{</span>
<span class="s1">  #  host = &quot;http://some-authenticated-host:9200&quot;</span>
<span class="s1">  #  name = &quot;Secured Cluster&quot;</span>
<span class="s1">  #  auth = {</span>
<span class="s1">  #    username = &quot;username&quot;</span>
<span class="s1">  #    password = &quot;secret-password&quot;</span>
<span class="s1">  #  }</span>
<span class="s1">  #}</span>
<span class="s1">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>启动服务</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nohup</span> <span class="o">./</span><span class="nb">bin</span><span class="o">/</span><span class="n">cerebro</span> <span class="o">&amp;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>访问web</p></li>
</ul>
<p>默认的访问地址为：http://IP:9000</p>
<p><img alt="cerebro.png" src="../../_images/cerebro.png" /></p>
</section>
</section>
<section id="id5">
<h2><span class="section-number">1.2. </span>基础<a class="headerlink" href="#id5" title="Link to this heading"></a></h2>
<section id="id6">
<h3><span class="section-number">1.2.1. </span>Elasticsearch相关术语<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<p><img alt="elastic.png" src="../../_images/elastic.png" /></p>
<p><strong>MySQL跟ElasticSearch对比</strong></p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Elasticsearch</th>
<th>MySQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>Index（索引）</td>
<td>Datobase（数据库）</td>
</tr>
<tr>
<td>Type（类型）</td>
<td>Table（数据表）</td>
</tr>
<tr>
<td>Document（文档）</td>
<td>Row（行）</td>
</tr>
<tr>
<td>Mapping</td>
<td>Schema</td>
</tr>
<tr>
<td>Fields（字段）</td>
<td>Column（列）</td>
</tr>
</tbody>
</table><ol class="simple">
<li><p>index（索引）: 一个索引就是一个拥有几分相似特征的文档的集合</p></li>
<li><p>type（类型）: 一个类型是索引的一个逻辑上的分类/分区,个索引中可以定义一种或多种类型</p></li>
<li><p>document（文档）: 文档是一个可被索引的基础信息单元，也就是一条数据。相当于MySQL中的一条记录</p></li>
<li><p>field（字段）: 对文档数据根据不同属性进行的分类标识</p></li>
<li><p>mapping（映射）: mapping是处理数据的方式和规则方面做一些限制，如某个字段的数据类型、默认值、分析器、是否被索引等</p></li>
<li><p>cluster（集群）: 一个集群就是由一个或多个节点组织在一起，它们共同持有整个的数据，并一起提供索引和搜索功能。</p></li>
<li><p>node（节点）: 一个节点是集群中的一个服务器，作为集群的一部分，它存储数据，参与集群的索引和搜索功能。</p></li>
<li><p>shard（分片）: 提供了将索引划分成多份的能力，这些份就叫做分片，允许你在分片之上进行分布式的、并行的操作，进而<em>提高性能/吞吐量</em></p></li>
<li><p>replicas（副本）： 创建分片的一份或多份备份，这些备份叫做复制分片，或者直接叫副本。在分片/节点失败的情况下，提供了<em>高可用性</em></p></li>
<li><p>allocation（分配）： 将分片分配给某个节点的过程，包括分配主分片或者副本。如果是副本，还包含从主分片复制数据的过程。这个过程是由master节点完成的。</p></li>
</ol>
<p><strong>集群状态</strong></p>
<p><img alt="../../_images/escluster.png" src="../../_images/escluster.png" /></p>
<ul class="simple">
<li><p>green: 表示所有的主分片和副本分片均正常工作</p></li>
<li><p>yellow： 表示部分副本分片不正常</p></li>
<li><p>red： 表示有部分主分片不正常工作</p></li>
</ul>
</section>
<section id="id7">
<h3><span class="section-number">1.2.2. </span>索引相关操作<a class="headerlink" href="#id7" title="Link to this heading"></a></h3>
<blockquote>
<div><p><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices.html">官网</a>: https://www.elastic.co/guide/en/elasticsearch/reference/current/indices.html</p>
</div></blockquote>
<section id="id8">
<h4><span class="section-number">1.2.2.1. </span>创建索引<a class="headerlink" href="#id8" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>创建默认索引(不指定分片和副本，默认为一个分片一个副本)</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X PUT http://elk1.linux.io:9200/dev-index-00?pretty
</pre></div>
</div>
<blockquote>
<div><p>索引名称建议不要出现以<code class="docutils literal notranslate"><span class="pre">.</span></code>、<code class="docutils literal notranslate"><span class="pre">_</span></code>、—`开头，索引名册不能出现大写。必须小写</p>
</div></blockquote>
<ul class="simple">
<li><p>创建指定(5个)分片和（2个副本）副本的索引</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">PUT</span> <span class="s1">&#39;http://elk1.linux.io:9200/dev-index-04?pretty&#39;</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;{</span>
    <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;number_of_shards&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;number_of_replicas&quot;</span><span class="p">:</span> <span class="mi">3</span> 
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span><span class="s1">&#39;</span>
<span class="c1"># output</span>
<span class="p">{</span>
  <span class="s2">&quot;acknowledged&quot;</span> <span class="p">:</span> <span class="n">true</span><span class="p">,</span>
  <span class="s2">&quot;shards_acknowledged&quot;</span> <span class="p">:</span> <span class="n">true</span><span class="p">,</span>
  <span class="s2">&quot;index&quot;</span> <span class="p">:</span> <span class="s2">&quot;dev-index-04&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p>副本数不应该小于集群节点数，否则集群会处于yellow状态</p>
</div></blockquote>
</section>
<section id="id9">
<h4><span class="section-number">1.2.2.2. </span>修改索引<a class="headerlink" href="#id9" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">PUT</span> <span class="s1">&#39;http://elk1.linux.io:9200/dev-index-04/_settings?pretty&#39;</span>  <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span>  <span class="s1">&#39;{</span>
    <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;number_of_replicas&quot;</span><span class="p">:</span> <span class="mi">2</span> 
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<blockquote>
<div><p>可修改索引的副本数，但是不能动态修改分片数。</p>
</div></blockquote>
</section>
<section id="id10">
<h4><span class="section-number">1.2.2.3. </span>查看索引<a class="headerlink" href="#id10" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>查看所有索引</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X GET http://elk1.linux.io:9200/_cat/indices?v
health status index            uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .geoip_databases ANg7J6ZfTPq6qyZ9K7MmoA   1   1         35            0       65mb         32.5mb
green  open   dev-index-01     cvRDzENCRtuaGievH2wo9g   1   1          0            0       452b           226b
green  open   dev-index-00     drO789YOT_GoKHV_sLwEyw   1   1          0            0       452b           226b
</pre></div>
</div>
<ul class="simple">
<li><p>查看单个索引</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span>    <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">dev</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mi">01</span>
</pre></div>
</div>
</section>
<section id="id11">
<h4><span class="section-number">1.2.2.4. </span>删除索引<a class="headerlink" href="#id11" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>删除单个索引</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X DELETE http://elk1.linux.io:9200/dev-index-03?pretty
</pre></div>
</div>
<ul class="simple">
<li><p>基于通配符删除多个索引</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X DELETE http://elk1.linux.io:9200/dev-index-*?pretty
</pre></div>
</div>
</section>
<section id="id12">
<h4><span class="section-number">1.2.2.5. </span>索引别名<a class="headerlink" href="#id12" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>添加索引别名</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X  POST http://elk1.linux.io:9200/_aliases?pretty -H &#39;Content-Type: application/json&#39; -d  &#39;{
    &quot;actions&quot;: [
        {
            &quot;add&quot;: {
                &quot;index&quot;: &quot;dev-index-00&quot;,
                &quot;alias&quot;: &quot;dev00&quot;
            }
        },
         {
            &quot;add&quot;: {
                &quot;index&quot;: &quot;dev-index-01&quot;,
                &quot;alias&quot;: &quot;dev02&quot;
            }
        }
    ]
}&#39;
</pre></div>
</div>
<ul class="simple">
<li><p>查看索引别名</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X GET http://elk1.linux.io:9200/_cat/aliases?v
</pre></div>
</div>
<ul class="simple">
<li><p>删除索引别名</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span>  <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_aliases</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span>  <span class="s1">&#39;{</span>
    <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;remove&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;dev-index-00&quot;</span><span class="p">,</span>
                <span class="s2">&quot;alias&quot;</span><span class="p">:</span> <span class="s2">&quot;dev00&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>修改索引别名</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_aliases</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span>  <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;remove&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;dev-index-01&quot;</span><span class="p">,</span>
                <span class="s2">&quot;alias&quot;</span><span class="p">:</span> <span class="s2">&quot;dev02&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
         <span class="p">{</span>
            <span class="s2">&quot;add&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;dev-index-01&quot;</span><span class="p">,</span>
                <span class="s2">&quot;alias&quot;</span><span class="p">:</span> <span class="s2">&quot;dev01&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="s1">&#39;</span>
</pre></div>
</div>
</section>
<section id="id13">
<h4><span class="section-number">1.2.2.6. </span>关闭索引<a class="headerlink" href="#id13" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X POST http://elk1.linux.io:9200/dev-index-01/_close
curl -X GET http://elk1.linux.io:9200/_cat/indices?v
</pre></div>
</div>
</section>
<section id="id14">
<h4><span class="section-number">1.2.2.7. </span>打开索引<a class="headerlink" href="#id14" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">dev</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mi">01</span><span class="o">/</span><span class="n">_open</span>
</pre></div>
</div>
</section>
<section id="id15">
<h4><span class="section-number">1.2.2.8. </span>索引模板<a class="headerlink" href="#id15" title="Link to this heading"></a></h4>
<p>索引模板是创建索引得一种方式，用户可以根据需求自定义对应的索引模板。</p>
<ul class="simple">
<li><p>查看所有的索引模板</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_template</span>
</pre></div>
</div>
<ul class="simple">
<li><p>查看单个索引模板</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_template</span><span class="o">/.</span><span class="n">monitoring</span><span class="o">-</span><span class="n">kibana</span>
</pre></div>
</div>
<ul class="simple">
<li><p>创建/修改索引模板</p></li>
</ul>
<p>索引如果匹配 <code class="docutils literal notranslate"><span class="pre">dev-docs-shopping*</span></code>， 则应用下面的索引模板，对已经存在得索引不生效</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_template</span><span class="o">/</span><span class="n">my</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mi">01</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span>  <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;aliases&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;website&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;shopapp&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;myshop&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="s2">&quot;index_patterns&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;dev-docs-shopping*&quot;</span>  
    <span class="p">],</span>
    <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;number_of_shards&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;number_of_replicas&quot;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;mappings&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;ip_addr&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ip&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;access_time&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;date&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span> <span class="p">:</span><span class="s2">&quot;text&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;keyword&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>删除索引模板:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">DELETE</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_template</span><span class="o">/</span><span class="n">my</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mi">01</span>
</pre></div>
</div>
</section>
</section>
<section id="id16">
<h3><span class="section-number">1.2.3. </span>文档基础操作<a class="headerlink" href="#id16" title="Link to this heading"></a></h3>
<p>elasticsearch是面向文档的搜索，文档是ES所有可搜索数据的最小单元。在ES中文档会被序列化成json格式进行保存，每个文档都会有一个Unique ID，这个ID可以有用户在创建文档的时候指定，在用户未指定时则由ES自己生成。</p>
<p>在ES中一个文档所包含的元数据如下：</p>
<p>_index：文档所属索引名称
_type：文档所属类型名
_id：文档唯一ID
_version：文档的版本信息
_seq_no：Shard级别严格递增的顺序号，保证后写入文档的_seq_no大于先写入文档的_seq_no
_primary_term：主分片发生重分配时递增1，主要用来恢复数据时处理当多个文档的_seq_no一样时的冲突
_score：相关性评分，在进行文档搜索时，根据该结果与搜索关键词的相关性进行评分
_source：文档的原始JSON数据</p>
<p>elasticsearch 中一个文档的栗子如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;students&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;_doc&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Vy8oDo8Brjjn75MKeoUE&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;created&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_shards&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;successful&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="s2">&quot;_seq_no&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;_primary_term&quot;</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="id17">
<h4><span class="section-number">1.2.3.1. </span>创建文档<a class="headerlink" href="#id17" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X PUT http://elk1.linux.io:9200/students?pretty
</pre></div>
</div>
<ul class="simple">
<li><p>不指定文档ID进行创建</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X POST http://elk1.linux.io:9200/students/_doc?pretty  -H &#39;Content-Type: application/json&#39; -d  &#39;
{
    &quot;name&quot;: &quot;张三&quot;,
    &quot;age&quot;: 20,
    &quot;hobby&quot;: [&quot;读书&quot;, &quot;写字&quot;]
}
&#39;
# output
{
  &quot;_index&quot;: &quot;students&quot;,
  &quot;_type&quot;: &quot;_doc&quot;,
  &quot;_id&quot;: &quot;Vy8oDo8Brjjn75MKeoUE&quot;,
  &quot;_version&quot;: 1,
  &quot;result&quot;: &quot;created&quot;,
  &quot;_shards&quot;: {
    &quot;total&quot;: 2,
    &quot;successful&quot;: 2,
    &quot;failed&quot;: 0
  },
  &quot;_seq_no&quot;: 0,
  &quot;_primary_term&quot;: 1
}
</pre></div>
</div>
<ul class="simple">
<li><p>指定文档ID进行创建</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X POST http://elk1.linux.io:9200/students/_doc/10001?pretty  -H &#39;Content-Type: application/json&#39; -d  &#39;
{
    &quot;name&quot;: &quot;Jerry&quot;,
    &quot;age&quot;: 20,
    &quot;hobby&quot;: [&quot;read&quot;, &quot;write&quot;, &quot;game&quot;]
}
&#39;

# output
{
  &quot;_index&quot;: &quot;students&quot;,
  &quot;_type&quot;: &quot;_doc&quot;,
  &quot;_id&quot;: &quot;10001&quot;,  # 文档ID
  &quot;_version&quot;: 1,
  &quot;result&quot;: &quot;created&quot;,
  &quot;_shards&quot;: {
    &quot;total&quot;: 2,
    &quot;successful&quot;: 2,
    &quot;failed&quot;: 0
  },
  &quot;_seq_no&quot;: 1,
  &quot;_primary_term&quot;: 2
}
</pre></div>
</div>
</section>
<section id="id18">
<h4><span class="section-number">1.2.3.2. </span>文档修改<a class="headerlink" href="#id18" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>全量修改</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">students</span><span class="o">/</span><span class="n">_doc</span><span class="o">/</span><span class="mi">10001</span>  <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span>  <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">31</span> 
<span class="p">}</span>
<span class="s1">&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>只修改或者某个字段</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">students</span><span class="o">/</span><span class="n">_doc</span><span class="o">/</span><span class="mi">10001</span><span class="o">/</span><span class="n">_update</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;doc&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;hobby&quot;</span><span class="p">:[</span><span class="s2">&quot;读书&quot;</span><span class="p">,</span><span class="s2">&quot;写字&quot;</span><span class="p">,</span><span class="s2">&quot;打球&quot;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;</span>
</pre></div>
</div>
</section>
<section id="id19">
<h4><span class="section-number">1.2.3.3. </span>文档查看<a class="headerlink" href="#id19" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X GET http://elk1.linux.io:9200/students/_search?pretty

# output
{
  &quot;took&quot;: 5,
  &quot;timed_out&quot;: false,
  &quot;_shards&quot;: {
    &quot;total&quot;: 1,
    &quot;successful&quot;: 1,
    &quot;skipped&quot;: 0,
    &quot;failed&quot;: 0
  },
  &quot;hits&quot;: {
    &quot;total&quot;: {
      &quot;value&quot;: 2, # 2个文档
      &quot;relation&quot;: &quot;eq&quot;
    },
    &quot;max_score&quot;: 1,
    &quot;hits&quot;: [
      {
        &quot;_index&quot;: &quot;students&quot;,
        &quot;_type&quot;: &quot;_doc&quot;,
        &quot;_id&quot;: &quot;Vy8oDo8Brjjn75MKeoUE&quot;, 
        &quot;_score&quot;: 1,
        &quot;_source&quot;: {
          &quot;name&quot;: &quot;张三&quot;,
          &quot;age&quot;: 20,
          &quot;hobby&quot;: [
            &quot;读书&quot;,
            &quot;写字&quot;
          ]
        }
      },
      {
        &quot;_index&quot;: &quot;students&quot;,
        &quot;_type&quot;: &quot;_doc&quot;,
        &quot;_id&quot;: &quot;10001&quot;,
        &quot;_score&quot;: 1,
        &quot;_source&quot;: {
          &quot;age&quot;: 20,
          &quot;hobby&quot;: [
            &quot;读书&quot;,
            &quot;写字&quot;,
            &quot;打球&quot;
          ]
        }
      }
    ]
  }
}
</pre></div>
</div>
</section>
<section id="id20">
<h4><span class="section-number">1.2.3.4. </span>删除文档<a class="headerlink" href="#id20" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>根据文档id进行删除</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">DELETE</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">students</span><span class="o">/</span><span class="n">_doc</span><span class="o">/</span><span class="mi">10001</span>
<span class="c1"># output</span>
<span class="p">{</span>
  <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;students&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;_doc&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;10001&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_version&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;deleted&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_shards&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;successful&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="s2">&quot;_seq_no&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="s2">&quot;_primary_term&quot;</span><span class="p">:</span> <span class="mi">2</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id21">
<h4><span class="section-number">1.2.3.5. </span>批量操作<a class="headerlink" href="#id21" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>批量创建</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span>  <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_bulk</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span>  <span class="s1">&#39;</span>
<span class="p">{</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;students&quot;</span><span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;小阿&quot;</span><span class="p">,</span><span class="s2">&quot;hobby&quot;</span><span class="p">:[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="s2">&quot;golang&quot;</span><span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;students&quot;</span><span class="p">,</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">1001</span><span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;小波&quot;</span><span class="p">,</span><span class="s2">&quot;hobby&quot;</span><span class="p">:[</span><span class="s2">&quot;java&quot;</span><span class="p">,</span><span class="s2">&quot;nodejs&quot;</span><span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;students&quot;</span><span class="p">,</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">1002</span><span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;小蔡&quot;</span><span class="p">,</span><span class="s2">&quot;hobby&quot;</span><span class="p">:[</span><span class="s2">&quot;篮球&quot;</span><span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;students&quot;</span><span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;大D&quot;</span><span class="p">,</span><span class="s2">&quot;hobby&quot;</span><span class="p">:[</span><span class="s2">&quot;旅游&quot;</span><span class="p">,</span><span class="s2">&quot;喝酒&quot;</span><span class="p">]</span> <span class="p">}</span> 
<span class="s1">&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>批量修改</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span>  <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_bulk</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span>  <span class="s1">&#39;</span>
<span class="p">{</span> <span class="s2">&quot;update&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="s2">&quot;1001&quot;</span><span class="p">,</span> <span class="s2">&quot;_index&quot;</span> <span class="p">:</span> <span class="s2">&quot;students&quot;</span><span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;doc&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;波波&quot;</span><span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;update&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="s2">&quot;1002&quot;</span><span class="p">,</span> <span class="s2">&quot;_index&quot;</span> <span class="p">:</span> <span class="s2">&quot;students&quot;</span><span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;doc&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;蔡老板&quot;</span><span class="p">}</span> <span class="p">}</span>
<span class="s1">&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>批量查询</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span>  <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_mget</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span>  <span class="s1">&#39;</span>
<span class="p">{</span>
  <span class="s2">&quot;docs&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;students&quot;</span><span class="p">,</span>
      <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1001&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;students&quot;</span><span class="p">,</span>
      <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1002&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span> 
<span class="s1">&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>批量删除</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span>  <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_bulk</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span>  <span class="s1">&#39;</span>
<span class="p">{</span> <span class="s2">&quot;delete&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;students&quot;</span><span class="p">,</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1001&quot;</span><span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;delete&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;students&quot;</span><span class="p">,</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1002&quot;</span><span class="p">}</span> <span class="p">}</span>
<span class="s1">&#39;</span>
</pre></div>
</div>
</section>
</section>
<section id="mapping">
<h3><span class="section-number">1.2.4. </span>Mapping配置<a class="headerlink" href="#mapping" title="Link to this heading"></a></h3>
</section>
<section id="id22">
<h3><span class="section-number">1.2.5. </span>分词器<a class="headerlink" href="#id22" title="Link to this heading"></a></h3>
<p>ElasticSearch 内置了分词器，如标准分词器、简单分词器、空白词器等。但这些分词器对我们最常使用的中文并不友好，不能按我们的语言习惯进行分词</p>
<section id="standard">
<h4><span class="section-number">1.2.5.1. </span>standard 分词器<a class="headerlink" href="#standard" title="Link to this heading"></a></h4>
<p>标准分词器模式使用空格和符号进行切割分词的。</p>
<ul class="simple">
<li><p>内置的标准分词器-分析英文</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_analyze</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;analyzer&quot;</span><span class="p">:</span> <span class="s2">&quot;standard&quot;</span><span class="p">,</span>
    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;My name is Dev Ops,  and I am 18 years old !&quot;</span>

<span class="p">}</span><span class="s1">&#39;|jq</span>

<span class="c1"># output</span>
<span class="p">{</span>
  <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;my&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;dev&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;ops&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">4</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;and&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">6</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;am&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">29</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">7</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;18&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;NUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">8</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;years&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">33</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">38</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">9</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;old&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">39</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">10</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>内置的标准分词器-分析中文并不友好</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_analyze</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;analyzer&quot;</span><span class="p">:</span> <span class="s2">&quot;standard&quot;</span><span class="p">,</span>
    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;我爱北京天安门, 毛主席万岁&quot;</span>

<span class="p">}</span><span class="s1">&#39;|jq</span>

<span class="c1"># output</span>
<span class="p">{</span>
  <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;我&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;爱&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;北&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;京&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;天&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">4</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;安&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;门&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">6</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;毛&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">7</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;主&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">8</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;席&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">9</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;万&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">10</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;岁&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">11</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="ik">
<h4><span class="section-number">1.2.5.2. </span>IK分词器<a class="headerlink" href="#ik" title="Link to this heading"></a></h4>
<p>ElasticSearch 内置了分词器，如标准分词器、简单分词器、空白词器等。但这些分词器对我们最常使用的中文并不友好，不能按我们的语言习惯进行分词。</p>
<p>ik分词器就是一个标准的中文分词器。它可以根据定义的字典对域进行分词，并且支持用户配置自己的字典，所以它除了可以按通用的习惯分词外，我们还可以定制化分词。</p>
<p>ik分词器是一个插件包，我们可以用插件的方式将它接入到ES。</p>
<ul class="simple">
<li><p>安装<a class="reference external" href="https://github.com/infinilabs/analysis-ik">ik分词器</a></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">infinilabs</span><span class="o">/</span><span class="n">analysis</span><span class="o">-</span><span class="n">ik</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">v7</span><span class="mf">.17.5</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">analysis</span><span class="o">-</span><span class="n">ik</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">.</span><span class="n">zip</span>
<span class="n">unzip</span> <span class="n">elasticsearch</span><span class="o">-</span><span class="n">analysis</span><span class="o">-</span><span class="n">ik</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">.</span><span class="n">zip</span>  <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">ik</span>
<span class="n">systemctl</span>  <span class="n">restart</span> <span class="n">es7</span>
</pre></div>
</div>
<ul class="simple">
<li><p>IK中文分词器-细粒度拆分</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_analyze</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;analyzer&quot;</span><span class="p">:</span> <span class="s2">&quot;ik_max_word&quot;</span><span class="p">,</span>
    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;我爱北京天安门, 毛主席万岁&quot;</span>

<span class="p">}</span><span class="s1">&#39;|jq</span>

<span class="c1"># output</span>
<span class="p">{</span>
  <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;我&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_CHAR&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;爱&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_CHAR&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;北京&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;天安门&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;天安&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">4</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;门&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_CHAR&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;毛主席万岁&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">6</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;毛主席&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">7</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;主席&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">8</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;万岁&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">9</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;万&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;TYPE_CNUM&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">10</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;岁&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;COUNT&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">11</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p>es集群需要在所有节点上都安装上此插件</p>
</div></blockquote>
<ul class="simple">
<li><p>IK中文分词器-粗粒度拆分</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_analyze</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;analyzer&quot;</span><span class="p">:</span> <span class="s2">&quot;ik_smart&quot;</span><span class="p">,</span>
    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;我爱北京天安门, 毛主席万岁&quot;</span>

<span class="p">}</span><span class="s1">&#39;|jq</span>

<span class="c1">#ouput</span>
<span class="p">{</span>
  <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;我&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_CHAR&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;爱&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_CHAR&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;北京&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;天安门&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;毛主席万岁&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">4</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>自定义IK分词器的字典</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 1. 进入到IK分词器的插件配置目录
cd /data/apps/elasticsearch-7.17.5/plugins/ik/config

# 2. 自定义字典
cat &gt; net-word.dic &lt;&lt;&#39;EOF&#39;
德玛西亚
艾欧尼亚
亚索
上号
带你飞
贼6
EOF

# 3. 加载自定义字典
vim IKAnalyzer.cfg.xml
&lt;properties&gt;
        ...
        &lt;!--用户可以在这里配置自己的扩展字典 --&gt;
        &lt;entry key=&quot;ext_dict&quot;&gt;net-word.dic&lt;/entry&gt;
        ...
&lt;/properties&gt;
              
# 4. 重启es集群
systemctl  restart es7
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_analyze</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;analyzer&quot;</span><span class="p">:</span> <span class="s2">&quot;ik_smart&quot;</span><span class="p">,</span>
    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;嗨，哥们! 上号，我德玛西亚和艾欧尼亚都有号! 我亚索贼6，肯定能带你飞!!!&quot;</span>
<span class="p">}</span>
<span class="s1">&#39;</span>

<span class="c1">#output</span>
<span class="p">{</span>
  <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;嗨&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_CHAR&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;哥们&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;上号&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;我&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_CHAR&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;德玛西亚&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">4</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;和&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_CHAR&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;艾欧尼亚&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">6</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;都有&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">7</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;号&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_CHAR&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">8</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;我&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_CHAR&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">9</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;亚索&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">10</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;贼6&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">29</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">11</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;肯定能&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">33</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">12</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;带你飞&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">33</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;CN_WORD&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">13</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="dsl">
<h3><span class="section-number">1.2.6. </span>DSL语句<a class="headerlink" href="#dsl" title="Link to this heading"></a></h3>
<p>Elasticsearch 提供了基于JSON的完整 Query DSL（Domain Specific Language，领域特定语言）来定义查询。</p>
<section id="id23">
<h4><span class="section-number">1.2.6.1. </span>准备数据<a class="headerlink" href="#id23" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>创建索引添加映射关系</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">PUT</span>  <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;mappings&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;double&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;keyword&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;long&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;auther&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;birthday&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span>
                <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;yyyy-MM-dd&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;province&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;keyword&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;keyword&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;remote_ip&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ip&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>准备数据，数据格式如下所示：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span>
<span class="o">...</span>
<span class="p">{</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;es-shopping-data&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;item&quot;</span><span class="p">:</span><span class="s2">&quot;https://item.jd.com/10045181911666.html&quot;</span><span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">:</span><span class="s2">&quot;华为（HUAWEI） 遥控器原装蓝牙NFC智慧屏语音控制鸿蒙电视S｜SE｜V系列可通用荣耀X1系列 黑色【盒装未拆封】支持NFC（HDRC-BV1）&quot;</span><span class="p">,</span><span class="s2">&quot;price&quot;</span><span class="p">:</span><span class="mf">159.00</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;electronic product&quot;</span><span class="p">,</span><span class="s2">&quot;group&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;auther&quot;</span><span class="p">:</span><span class="s2">&quot;张三&quot;</span><span class="p">,</span><span class="s2">&quot;birthday&quot;</span><span class="p">:</span><span class="s2">&quot;1993-12-03&quot;</span><span class="p">,</span><span class="s2">&quot;province&quot;</span><span class="p">:</span><span class="s2">&quot;云南&quot;</span><span class="p">,</span><span class="s2">&quot;city&quot;</span><span class="p">:</span><span class="s2">&quot;曲靖&quot;</span><span class="p">,</span><span class="s2">&quot;remote_ip&quot;</span><span class="p">:</span><span class="s2">&quot;211.144.24.221&quot;</span><span class="p">}</span>
<span class="o">...</span>
</pre></div>
</div>
<ul class="simple">
<li><p>批量插入数据</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_bulk</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">--</span><span class="n">data</span><span class="o">-</span><span class="n">binary</span>  <span class="nd">@data</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
</section>
<section id="match">
<h4><span class="section-number">1.2.6.2. </span>全文检索-match<a class="headerlink" href="#match" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>查询张山相关的所有数据,只要含有张或者山，或者张山的数据都会被匹配</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;match&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;auther&quot;</span><span class="p">:</span><span class="s2">&quot;张山&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
</section>
<section id="match-phrase">
<h4><span class="section-number">1.2.6.3. </span>精确匹配-match_phrase<a class="headerlink" href="#match-phrase" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>查询张山的数据，必须精确匹配张三</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;match_phrase&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;auther&quot;</span><span class="p">:</span><span class="s2">&quot;张山&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
</section>
<section id="match-all">
<h4><span class="section-number">1.2.6.4. </span>全量查询-match_all<a class="headerlink" href="#match-all" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match_all&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
</section>
<section id="id24">
<h4><span class="section-number">1.2.6.5. </span>分页查询<a class="headerlink" href="#id24" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>每页显示3条数据，查询第四页，如果一个数据总共有total条文档，那么我们想要就知道一共有<code class="docutils literal notranslate"><span class="pre">m=int（total/n）+1</span></code>页，如果想要查询最后一页数据则 <code class="docutils literal notranslate"><span class="pre">from=(m-1)*n</span></code></p>
<ul>
<li><p>size： 单页返回的文档数，此处设置为n条</p></li>
<li><p>from：跳过多少条文档数</p></li>
</ul>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;match_phrase&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;auther&quot;</span><span class="p">:</span><span class="s2">&quot;张三&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;from&quot;</span><span class="p">:</span><span class="mi">9</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
<ul class="simple">
<li><p>查询第六组数据，每页显示7条数据，查询第9页</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;match&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;group&quot;</span><span class="p">:</span><span class="mi">6</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="mi">56</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
<blockquote>
<div><p>生产环境中，不建议深度分页，百度的页码数量控制在76页左右。</p>
</div></blockquote>
</section>
<section id="source">
<h4><span class="section-number">1.2.6.6. </span>查看的指定字段-<code class="docutils literal notranslate"><span class="pre">_source</span></code><a class="headerlink" href="#source" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;match_phrase&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;auther&quot;</span><span class="p">:</span><span class="s2">&quot;张三&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;_source&quot;</span><span class="p">:[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span><span class="s2">&quot;auther&quot;</span><span class="p">,</span><span class="s2">&quot;price&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
</section>
<section id="exists">
<h4><span class="section-number">1.2.6.7. </span>查询存在某个字段的文档-exists<a class="headerlink" href="#exists" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;exists&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;hobby&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
</section>
<section id="id25">
<h4><span class="section-number">1.2.6.8. </span>语法高亮<a class="headerlink" href="#id25" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match_phrase&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;孙子兵法&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;highlight&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;pre_tags&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;&lt;span style=&#39;color:red;&#39;&gt;&quot;</span>
        <span class="p">],</span>
        <span class="s2">&quot;post_tags&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;&lt;/span&gt;&quot;</span>
        <span class="p">],</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
</section>
<section id="id26">
<h4><span class="section-number">1.2.6.9. </span>排序查询<a class="headerlink" href="#id26" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>升序查询最便宜商品及价格</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;match_phrase&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;auther&quot;</span><span class="p">:</span><span class="s2">&quot;张三&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sort&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;price&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="s2">&quot;asc&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">1</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
<ul class="simple">
<li><p>降序查询最贵的商品及价格</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;match_phrase&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;auther&quot;</span><span class="p">:</span><span class="s2">&quot;张山&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sort&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;price&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="s2">&quot;desc&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">1</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
</section>
<section id="bool">
<h4><span class="section-number">1.2.6.10. </span>多条件查询-bool<a class="headerlink" href="#bool" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>查看作者是张山且商品价格为24.90</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;must&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match_phrase&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;auther&quot;</span><span class="p">:</span> <span class="s2">&quot;张山&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">24.90</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
<ul class="simple">
<li><p>查看作者是张山或者是李四的商品并降序排序</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match_phrase&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;auther&quot;</span><span class="p">:</span> <span class="s2">&quot;张山&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match_phrase&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;auther&quot;</span><span class="p">:</span> <span class="s2">&quot;李四&quot;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sort&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;price&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="s2">&quot;desc&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
<ul class="simple">
<li><p>查看作者是张山或者是李四且商品价格为168或者198</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match_phrase&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;auther&quot;</span><span class="p">:</span> <span class="s2">&quot;张山&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match_phrase&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;auther&quot;</span><span class="p">:</span> <span class="s2">&quot;李四&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">168.00</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">198.00</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;minimum_should_match&quot;</span><span class="p">:</span> <span class="s2">&quot;60%&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
<ul class="simple">
<li><p>查看作者不是张山或者是李四且商品价格为168或者198的商品</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;must_not&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match_phrase&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;auther&quot;</span><span class="p">:</span> <span class="s2">&quot;张山&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match_phrase&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;auther&quot;</span><span class="p">:</span> <span class="s2">&quot;李四&quot;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">168.00</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">198.00</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;minimum_should_match&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
</section>
<section id="filter">
<h4><span class="section-number">1.2.6.11. </span>过滤查询-filter<a class="headerlink" href="#filter" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>查询3组成员产品价格3599到10500的商品的最便宜的3个</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;must&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="mi">3</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;gte&quot;</span><span class="p">:</span> <span class="mi">3599</span><span class="p">,</span>
                        <span class="s2">&quot;lte&quot;</span><span class="p">:</span> <span class="mi">10500</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sort&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="s2">&quot;asc&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
<ul class="simple">
<li><p>查询2,4,6这3个组的最贵的3个产品且不包含酒的商品</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;must_not&quot;</span><span class="p">:[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match&quot;</span><span class="p">:{</span>
                        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;酒&quot;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match&quot;</span><span class="p">:{</span>
                        <span class="s2">&quot;group&quot;</span><span class="p">:</span><span class="mi">2</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                 <span class="p">{</span>
                    <span class="s2">&quot;match&quot;</span><span class="p">:{</span>
                        <span class="s2">&quot;group&quot;</span><span class="p">:</span><span class="mi">4</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                 <span class="p">{</span>
                    <span class="s2">&quot;match&quot;</span><span class="p">:{</span>
                        <span class="s2">&quot;group&quot;</span><span class="p">:</span><span class="mi">6</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;sort&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;price&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="s2">&quot;desc&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">3</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
</section>
<section id="terms">
<h4><span class="section-number">1.2.6.12. </span>精确匹配多个值-terms<a class="headerlink" href="#terms" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>查询商品价格为9.9和19.8的商品</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="mf">9.9</span><span class="p">,</span>
                <span class="mf">19.9</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
</section>
<section id="id27">
<h4><span class="section-number">1.2.6.13. </span>多词搜索<a class="headerlink" href="#id27" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>多词搜索包含”小面包”关键字的所有商品</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">es</span><span class="o">-</span><span class="n">shopping</span><span class="o">-</span><span class="n">data</span><span class="o">/</span><span class="n">_search</span>  <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;must&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;小面包&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;and&quot;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;highlight&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;pre_tags&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;&lt;h1&gt;&quot;</span>
        <span class="p">],</span>
        <span class="s2">&quot;post_tags&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;&lt;/h1&gt;&quot;</span>
        <span class="p">],</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;|jq</span>
</pre></div>
</div>
</section>
<section id="id28">
<h4><span class="section-number">1.2.6.14. </span>权重查询<a class="headerlink" href="#id28" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X GET http://elk1.linux.io:9200/es-shopping-data/_search?pretty  -H &quot;Content-Type: application/json&quot;  -d &#39;
{
    &quot;query&quot;: {
        &quot;bool&quot;: {
            &quot;must&quot;: [
                {
                    &quot;match&quot;: {
                        &quot;title&quot;: {
                            &quot;query&quot;: &quot;小面包&quot;,
                            &quot;operator&quot;: &quot;and&quot;
                        }
                    }
                }
            ],
            &quot;should&quot;: [
                {
                    &quot;match&quot;: {
                        &quot;title&quot;: {
                            &quot;query&quot;: &quot;下午茶&quot;,
                            &quot;boost&quot;: 5
                        }
                    }
                },
                {
                    &quot;match&quot;: {
                        &quot;title&quot;: {
                            &quot;query&quot;: &quot;良品铺子&quot;,
                            &quot;boost&quot;: 2
                        }
                    }
                }
            ]
        }
    },
    &quot;highlight&quot;: {
        &quot;pre_tags&quot;: [
            &quot;&lt;h1&gt;&quot;
        ],
        &quot;post_tags&quot;: [
            &quot;&lt;/h1&gt;&quot;
        ],
        &quot;fields&quot;: {
            &quot;title&quot;: {}
        }
    }
}
&#39;
</pre></div>
</div>
</section>
<section id="aggs">
<h4><span class="section-number">1.2.6.15. </span>聚合查询-aggs<a class="headerlink" href="#aggs" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>统计每个组收集的商品数量</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X GET http://elk1.linux.io:9200/es-shopping-data/_search?pretty  -H &quot;Content-Type: application/json&quot;  -d &#39;
{
    
    &quot;aggs&quot;: {
        &quot;item_group_count&quot;: {
            &quot;terms&quot;:{
                &quot;field&quot;: &quot;group&quot;
            }
        }
    },
    &quot;size&quot;: 0
}
&#39;
</pre></div>
</div>
<ul class="simple">
<li><p>统计2组最贵的商品</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X GET http://elk1.linux.io:9200/es-shopping-data/_search?pretty  -H &quot;Content-Type: application/json&quot;  -d &#39;
{
    &quot;query&quot;: {
        &quot;match&quot;: {
            &quot;group&quot;: 2
        }
    },
    &quot;aggs&quot;: {
        &quot;item_max_shopping&quot;: {
            &quot;max&quot;: {
                &quot;field&quot;: &quot;price&quot;
            }
        }
    },
    &quot;sort&quot;:{
        &quot;price&quot;:{
            &quot;order&quot;:&quot;desc&quot;
        }
    },
    &quot;size&quot;: 1   
}
&#39;
</pre></div>
</div>
<ul class="simple">
<li><p>统计3组最便宜的商品</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X GET http://elk1.linux.io:9200/es-shopping-data/_search?pretty  -H &quot;Content-Type: application/json&quot;  -d &#39;
{
    &quot;query&quot;: {
        &quot;match&quot;: {
            &quot;group&quot;: 3
        }
    },
    &quot;aggs&quot;: {
        &quot;item_min_shopping&quot;: {
            &quot;min&quot;: {
                &quot;field&quot;: &quot;price&quot;
            }
        }
    },
    &quot;sort&quot;:{
        &quot;price&quot;:{
            &quot;order&quot;: &quot;asc&quot;
        }
    },
    &quot;size&quot;: 1
}
&#39;
</pre></div>
</div>
<ul class="simple">
<li><p>统计4组商品的平均价格</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X GET http://elk1.linux.io:9200/es-shopping-data/_search?pretty  -H &quot;Content-Type: application/json&quot;  -d &#39;
{
    &quot;query&quot;: {
        &quot;match&quot;: {
            &quot;group&quot;: 4
        }
    },
    &quot;aggs&quot;: {
        &quot;item_avg_shopping&quot;: {
            &quot;avg&quot;: {
                &quot;field&quot;: &quot;price&quot;
            }
        }
    },
    &quot;size&quot;: 0
}
&#39;
</pre></div>
</div>
<ul class="simple">
<li><p>统计买下5组所有商品要多少钱</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X GET http://elk1.linux.io:9200/es-shopping-data/_search?pretty  -H &quot;Content-Type: application/json&quot;  -d &#39;
{
    &quot;query&quot;: {
        &quot;match&quot;: {
            &quot;group&quot;:5
        }
    },
    &quot;aggs&quot;: {
        &quot;item_sum_shopping&quot;: {
            &quot;sum&quot;: {
                &quot;field&quot;: &quot;price&quot;
            }
        }
    },
    &quot;size&quot;: 0
}
&#39;
</pre></div>
</div>
</section>
</section>
</section>
<section id="id29">
<h2><span class="section-number">1.3. </span>进阶<a class="headerlink" href="#id29" title="Link to this heading"></a></h2>
<section id="api">
<h3><span class="section-number">1.3.1. </span>集群常用API<a class="headerlink" href="#api" title="Link to this heading"></a></h3>
<section id="reindex">
<h4><span class="section-number">1.3.1.1. </span>集群迁移-reindex<a class="headerlink" href="#reindex" title="Link to this heading"></a></h4>
<blockquote>
<div><p><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html">官网</a>: https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html</p>
</div></blockquote>
<ul class="simple">
<li><p>同集群节点迁移</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X POST http://elk1.linux.io:9200/_reindex?pretty -H &quot;Content-Type: application/json&quot;  -d &#39;
{
    &quot;source&quot;: {
        &quot;index&quot;: &quot;es-shopping-data&quot;
    },
    &quot;dest&quot;: {
        &quot;index&quot;: &quot;es-shopping-data-new&quot;
    }
}
&#39;
# output 
{
  &quot;took&quot; : 2264,
  &quot;timed_out&quot; : false,
  &quot;total&quot; : 531,
  &quot;updated&quot; : 0,
  &quot;created&quot; : 531,
  &quot;deleted&quot; : 0,
  &quot;batches&quot; : 1,
  &quot;version_conflicts&quot; : 0,
  &quot;noops&quot; : 0,
  &quot;retries&quot; : {
    &quot;bulk&quot; : 0,
    &quot;search&quot; : 0
  },
  &quot;throttled_millis&quot; : 0,
  &quot;requests_per_second&quot; : -1.0,
  &quot;throttled_until_millis&quot; : 0,
  &quot;failures&quot; : [ ]
}

# 验证
curl -X GET http://elk1.linux.io:9200/_cat/count/es-shopping-data-new?v
epoch      timestamp count
1714021975 05:12:55  531
curl -X GET http://elk1.linux.io:9200/_cat/count/es-shopping-data?v    
epoch      timestamp count
1714021980 05:13:00  531
</pre></div>
</div>
<ul class="simple">
<li><p>跨集群之间数据迁移，将集群A的数据迁移到集群B</p>
<ul>
<li><p>集群A：http://elk1.linux.io:9200/</p></li>
<li><p>集群B: http://newes.linux.io:9200</p></li>
</ul>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 1.在新的集群B的配置文件添加如下配置：
# 表示添加远程主机的白名单，用于数据迁移信任的主机,其中192.168.1为集群B所在的IP地址段
reindex.remote.whitelist: [&quot;192.168.1.*:9200&quot;, &quot;elk1.linux.io:9200&quot;]

# 2. 重启集群B上的es服务
 systemctl  restart elasticsearch

# 3. 在集群B上执行迁移数据命令
curl -X POST http://newes.linux.io:9200/_reindex?pretty -H &quot;Content-Type: application/json&quot;  -d &#39;
{
    &quot;source&quot;: {
        &quot;index&quot;: &quot;es-shopping-data&quot;,
        &quot;remote&quot;: {
            &quot;host&quot;: &quot;http://elk1.linux.io:9200/&quot;
        },
        &quot;query&quot;: {
            &quot;match_all&quot;: {}
        }
    },
    &quot;dest&quot;: {
        &quot;index&quot;: &quot;es-shopping-data&quot;
    }
}
&#39;

# 5. 验证
curl -X GET http://elk1.linux.io:9200/_cat/count/es-shopping-data?v
epoch      timestamp count
1714024803 06:00:03  531
curl -X GET http://newes.linux.io:9200/_cat/count/es-shopping-data?v
epoch      timestamp count
1714024813 06:00:13  531
</pre></div>
</div>
</section>
<section id="id30">
<h4><span class="section-number">1.3.1.2. </span>集群状态<a class="headerlink" href="#id30" title="Link to this heading"></a></h4>
<blockquote>
<div><p><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-state.html">官网</a>: https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-state.html</p>
</div></blockquote>
<ul class="simple">
<li><p>查看集群的状态</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cluster</span><span class="o">/</span><span class="n">health</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">|</span><span class="n">jq</span> 
<span class="p">{</span>
  <span class="s2">&quot;cluster_name&quot;</span><span class="p">:</span> <span class="s2">&quot;dev-es7-cluster&quot;</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
  <span class="s2">&quot;timed_out&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;number_of_nodes&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="s2">&quot;number_of_data_nodes&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="s2">&quot;active_primary_shards&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
  <span class="s2">&quot;active_shards&quot;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
  <span class="s2">&quot;relocating_shards&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;initializing_shards&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;unassigned_shards&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;delayed_unassigned_shards&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;number_of_pending_tasks&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;number_of_in_flight_fetch&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;task_max_waiting_in_queue_millis&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;active_shards_percent_as_number&quot;</span><span class="p">:</span> <span class="mi">100</span>
<span class="p">}</span>
</pre></div>
</div>
<p>| 字段 | 说明 |
| – | – |
| cluster_name | 集群名称 |
| status |  集群的健康状态，基于其主分片和副本分片的状态 |
| timed_out | 是否在参数false指定的时间段内返回响应（默认情况下30秒）。 |
| number_of_nodes |    集群内的节点数。|
| number_of_data_nodes |  作为专用数据节点的节点数 |
| active_primary_shards |   可用主分片的数量 |
| active_shards |  可用主分片和副本分片的总数 |
| relocating_shards | 正在重定位的分片数 |
| initializing_shards | 正在初始化的分片数 |
| unassigned_shards | 未分配的分片数|
| delayed_unassigned_shards | 分配因超时设置而延迟的分片数|
| number_of_pending_tasks | 尚未执行的集群级别更改的数量 |
| number_of_in_flight_fetch | 未完成的提取次数 |
| task_max_waiting_in_queue_millis | 自最早启动的任务等待执行以来的时间（以毫秒为单位）|
| active_shards_percent_as_number | 集群中活动分片的比率，以百分比表示 |</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cluster</span><span class="o">/</span><span class="n">health</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">.</span><span class="n">status</span>
<span class="s2">&quot;green&quot;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cluster</span><span class="o">/</span><span class="n">health</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">.</span><span class="n">active_shards_percent_as_number</span>
<span class="mi">100</span>
</pre></div>
</div>
<ul class="simple">
<li><p>集群状态数据</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl http://elk1.linux.io:9200/_cluster/state?pretty
</pre></div>
</div>
<ul class="simple">
<li><p>只查看集群的节点信息</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl http://elk1.linux.io:9200/_cluster/state/nodes?pretty
</pre></div>
</div>
<ul class="simple">
<li><p>查看nodes,version,routing_table这些信息，并且查看以”dev*”开头的所有索引</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl http://elk1.linux.io:9200/_cluster/state/nodes,version,routing_table/dev*?pretty
</pre></div>
</div>
<ul class="simple">
<li><p>集群的统计信息</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cluster</span><span class="o">/</span><span class="n">stats</span>
</pre></div>
</div>
</section>
<section id="id31">
<h4><span class="section-number">1.3.1.3. </span>集群的分片情况<a class="headerlink" href="#id31" title="Link to this heading"></a></h4>
<blockquote>
<div><p><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-allocation-explain.html">官网</a>: https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-allocation-explain.html</p>
</div></blockquote>
<p>查看集群的分片分配情况（allocation）</p>
<ul class="simple">
<li><p>集群分配解释API的目的是为集群中的分片分配提供解释。</p></li>
<li><p>对于未分配的分片，解释 API 提供了有关未分配分片的原因的解释</p></li>
<li><p>对于分配的分片，解释 API 解释了为什么分片保留在其当前节点上并且没有移动或重新平衡到另一个节点</p></li>
<li><p>尝试诊断分片未分配的原因或分片继续保留在其当前节点上的原因</p></li>
<li><p>分析students索引的0号分片未分配的原因</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">elk1</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cluster</span><span class="o">/</span><span class="n">allocation</span><span class="o">/</span><span class="n">explain</span>
<span class="p">{</span>
  <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;studentsr&quot;</span><span class="p">,</span>
  <span class="s2">&quot;shard&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;primary&quot;</span><span class="p">:</span> <span class="n">true</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id32">
<h4><span class="section-number">1.3.1.4. </span>集群分片重路由<a class="headerlink" href="#id32" title="Link to this heading"></a></h4>
<blockquote>
<div><p><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-reroute.html">官网</a>: https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-reroute.html</p>
</div></blockquote>
<p>reroute 命令允许手动更改集群中各个分片的分配,可以将分片从一个节点显式移动到另一个节点，可以取消分配，并且可以将未分配的分片显式分配给特定节点。</p>
<ul class="simple">
<li><p>将”students”索引的0号分片从elk1节点移动到elk2节点</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X POST http://newes.linux.io:9200/_cluster/reroute?pretty -H &quot;Content-Type: application/json&quot;  -d &#39;
{
    &quot;commands&quot;: [
        {
            &quot;move&quot;: {
                &quot;index&quot;: &quot;students&quot;,
                &quot;shard&quot;: 0,
                &quot;from_node&quot;: &quot;elk1.linux.io&quot;,
                &quot;to_node&quot;: &quot;elk2.linux.io&quot;
            }
        }
    ]
}
&#39;
</pre></div>
</div>
<ul class="simple">
<li><p>取消副本分片的分配，其副本会重新初始化分配</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X POST http://newes.linux.io:9200/_cluster/reroute?pretty -H &quot;Content-Type: application/json&quot;  -d &#39;
{
    &quot;commands&quot;: [
        {
            &quot;cancel&quot;: {
                &quot;index&quot;: &quot;students&quot;,
                &quot;shard&quot;: 0,
                &quot;node&quot;: &quot;elk3.linux.io&quot;
            }
        }
    ]
}

&#39;
</pre></div>
</div>
</section>
<section id="id33">
<h4><span class="section-number">1.3.1.5. </span>集群配置优先级<a class="headerlink" href="#id33" title="Link to this heading"></a></h4>
<blockquote>
<div><p><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-get-settings.html">官网</a>: https://www.elastic.co/guide/en/elasticsearch/reference/7.17/cluster-get-settings.html</p>
</div></blockquote>
<p>es集群的配置可以通过多种方式配置，不一样的配置方式按照以下优先顺序进行应用</p>
<ul class="simple">
<li><p>Transient setting(临时配置，集群重启后失效)</p></li>
<li><p>Persistent setting(持久化配置，集群重启后依旧生效)</p></li>
<li><p>elasticsearch.yml setting(配置文件)</p></li>
<li><p>Default setting value(默认设置值)</p></li>
<li><p>查询集群的所有配置信息</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl http://elk1.linux.io:9200/_cluster/settings?include_defaults=true&amp;flat_settings=true
</pre></div>
</div>
<ul class="simple">
<li><p>修改集群的配置</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">PUT</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">newes</span><span class="o">.</span><span class="n">linux</span><span class="o">.</span><span class="n">io</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cluster</span><span class="o">/</span><span class="n">settings</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span>  <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;transient&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;cluster.routing.allocation.enable&quot;</span><span class="p">:</span> <span class="s2">&quot;primaries&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="s1">&#39;</span>
</pre></div>
</div>
</section>
</section>
<section id="id34">
<h3><span class="section-number">1.3.2. </span>集群角色<a class="headerlink" href="#id34" title="Link to this heading"></a></h3>
</section>
<section id="id35">
<h3><span class="section-number">1.3.3. </span>文档写入流程<a class="headerlink" href="#id35" title="Link to this heading"></a></h3>
<p><img alt="../../_images/doc.png" src="../../_images/doc.png" /></p>
</section>
<section id="id36">
<h3><span class="section-number">1.3.4. </span>文档读取流程<a class="headerlink" href="#id36" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>单个文档
<img alt="../../_images/doc1.png" src="../../_images/doc1.png" /></p></li>
<li><p>多个文档
<img alt="../../_images/doc2.png" src="../../_images/doc2.png" /></p></li>
</ul>
</section>
<section id="id37">
<h3><span class="section-number">1.3.5. </span>底层存储原理<a class="headerlink" href="#id37" title="Link to this heading"></a></h3>
<p><img alt="../../_images/doc0.png" src="../../_images/doc0.png" /></p>
</section>
</section>
</section>
<section id="kibana">
<h1><span class="section-number">2. </span>Kibana<a class="headerlink" href="#kibana" title="Link to this heading"></a></h1>
<section id="id38">
<h2><span class="section-number">2.1. </span>安装<a class="headerlink" href="#id38" title="Link to this heading"></a></h2>
<p><strong>rpm包安装</strong></p>
<ul class="simple">
<li><p>下载软件包</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="o">.</span><span class="n">tuna</span><span class="o">.</span><span class="n">tsinghua</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">elasticstack</span><span class="o">/</span><span class="mf">7.</span><span class="n">x</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="mf">7.17.5</span><span class="o">/</span><span class="n">kibana</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
</pre></div>
</div>
<ul class="simple">
<li><p>安装</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span>  <span class="n">localinstall</span> <span class="o">./</span><span class="n">kibana</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
</pre></div>
</div>
<ul class="simple">
<li><p>配置</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kibana</span><span class="o">/</span><span class="n">kibana</span><span class="o">.</span><span class="n">yml</span>
<span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">:</span> <span class="mi">5601</span>
<span class="n">server</span><span class="o">.</span><span class="n">host</span><span class="p">:</span> <span class="s2">&quot;0.0.0.0&quot;</span>
<span class="n">elasticsearch</span><span class="o">.</span><span class="n">hosts</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;http://192.168.122.136:9200&quot;</span><span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>启动</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">systemctl</span>  <span class="n">enable</span> <span class="n">kibana</span> <span class="o">--</span><span class="n">now</span>
</pre></div>
</div>
<ul class="simple">
<li><p>访问 http://IP:5601</p></li>
</ul>
</section>
</section>
<section id="filebeat">
<h1><span class="section-number">3. </span>FileBeat<a class="headerlink" href="#filebeat" title="Link to this heading"></a></h1>
<section id="id39">
<h2><span class="section-number">3.1. </span>安装<a class="headerlink" href="#id39" title="Link to this heading"></a></h2>
<section id="rpm">
<h3><span class="section-number">3.1.1. </span>rpm 包安装<a class="headerlink" href="#rpm" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>下载</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="o">.</span><span class="n">tuna</span><span class="o">.</span><span class="n">tsinghua</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">elasticstack</span><span class="o">/</span><span class="mf">7.</span><span class="n">x</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="mf">7.17.5</span><span class="o">/</span><span class="n">filebeat</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
</pre></div>
</div>
<ul class="simple">
<li><p>安装</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="o">./</span><span class="n">filebeat</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span> 
</pre></div>
</div>
</section>
<section id="id40">
<h3><span class="section-number">3.1.2. </span>预编译二进制包安装<a class="headerlink" href="#id40" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>下载</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">artifacts</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span><span class="o">/</span><span class="n">downloads</span><span class="o">/</span><span class="n">beats</span><span class="o">/</span><span class="n">filebeat</span><span class="o">/</span><span class="n">filebeat</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>
</div>
<ul class="simple">
<li><p>安装</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tar</span> <span class="o">-</span><span class="n">xf</span> <span class="n">filebeat</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="o">-</span><span class="n">C</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">sv</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">filebeat</span><span class="o">-</span><span class="mf">7.17.5</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">/</span><span class="n">filebeat</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">filebeat</span>
</pre></div>
</div>
<ul class="simple">
<li><p>配置</p></li>
</ul>
<p>filebeat 默认使用当前目录下的 <code class="docutils literal notranslate"><span class="pre">filebeat.yml</span></code> 文件作为配置文件，也可使用 <code class="docutils literal notranslate"><span class="pre">-c</span></code> 指定配置文件路径。配置文件一般需要按需求定制，所有这里提供标准输入到控制台配置，详细使用配置见下面的章节</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">config</span><span class="o">/</span><span class="mi">01</span><span class="o">-</span><span class="n">stdin</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">console</span><span class="o">.</span><span class="n">yml</span> 
<span class="n">filebeat</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
<span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">stdin</span>

<span class="n">output</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
  <span class="n">pretty</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<ul class="simple">
<li><p>启动</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filebeat</span>  <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">c</span> <span class="o">./</span><span class="n">config</span><span class="o">/</span><span class="mi">01</span><span class="o">-</span><span class="n">stdin</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">console</span><span class="o">.</span><span class="n">yml</span> 
</pre></div>
</div>
</section>
</section>
<section id="id41">
<h2><span class="section-number">3.2. </span>配置<a class="headerlink" href="#id41" title="Link to this heading"></a></h2>
<blockquote>
<div><p><a class="reference external" href="https://www.elastic.co/guide/en/beats/filebeat/7.15/configuration-filebeat-options.html">官网</a>: https://www.elastic.co/guide/en/beats/filebeat/7.15/configuration-filebeat-options.html</p>
</div></blockquote>
<section id="input">
<h3><span class="section-number">3.2.1. </span>Input 插件<a class="headerlink" href="#input" title="Link to this heading"></a></h3>
<section id="tcp">
<h4><span class="section-number">3.2.1.1. </span>Tcp插件<a class="headerlink" href="#tcp" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filebeat</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
<span class="c1"># 指定类型为tcp</span>
<span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">tcp</span>
  <span class="n">max_message_size</span><span class="p">:</span> <span class="mi">10</span><span class="n">MiB</span>
   <span class="c1"># 定义tcp监听的主机和端口</span>
  <span class="n">host</span><span class="p">:</span> <span class="s2">&quot;localhost:9000&quot;</span>
<span class="c1"># 指定filebeat的输出端为console</span>
<span class="n">output</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
  <span class="c1"># 表示输出的内容以漂亮的格式显示</span>
  <span class="n">pretty</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 验证</span>
 <span class="n">echo</span> <span class="s2">&quot;AAAAAAAA&quot;</span> <span class="o">|</span><span class="n">nc</span> <span class="n">localhost</span> <span class="mi">9000</span>
</pre></div>
</div>
</section>
<section id="log">
<h4><span class="section-number">3.2.1.2. </span>Log插件<a class="headerlink" href="#log" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filebeat</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
  <span class="c1"># 指定输入类型是log</span>
<span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">log</span>
  <span class="c1"># 指定文件路径</span>
  <span class="n">paths</span><span class="p">:</span>
    <span class="c1"># 匹配 /tmp/test/1.log</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">/*.</span><span class="n">log</span>
    <span class="c1"># 匹配 /tmp/test/sub/1.log</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">/*/*.</span><span class="n">log</span>
    <span class="c1"># 两个*可以递归匹配, 匹配 /tmp/test/1.log, /tmp/test/sub/1.log</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">/**/*.</span><span class="n">log</span> 
  <span class="c1"># 排除以exe结尾的文件</span>
  <span class="n">exclude_files</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;\.exe$&#39;</span><span class="p">]</span>

  <span class="c1"># 只采集包含指定信息的数据 </span>
  <span class="n">include_lines</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ERROR&#39;</span><span class="p">]</span>

  <span class="c1"># 只要包含特定的数据就不采集该事件(event)</span>
  <span class="n">exclude_lines</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;^INFO&#39;</span><span class="p">]</span>
  <span class="c1"># 将message字段的json数据格式进行解析，并将解析的结果放在顶级字段中</span>
  <span class="n">json</span><span class="o">.</span><span class="n">keys_under_root</span><span class="p">:</span> <span class="n">true</span>

  <span class="c1"># 如果解析json格式失败，则会将错误信息添加为一个&quot;error&quot;字段输出</span>
  <span class="n">json</span><span class="o">.</span><span class="n">add_error_key</span><span class="p">:</span> <span class="n">true</span>

<span class="c1"># 指定filebeat的输出端为console</span>
<span class="n">output</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
  <span class="c1"># 表示输出的内</span>
</pre></div>
</div>
</section>
<section id="id42">
<h4><span class="section-number">3.2.1.3. </span>Input通用字段<a class="headerlink" href="#id42" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filebeat</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
  <span class="c1"># 指定输入类型是log</span>
<span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">log</span>
  <span class="c1"># 指定文件路径</span>
  <span class="n">paths</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">/*.</span><span class="n">log</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">/*/*.</span><span class="n">log</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">/**/*.</span><span class="n">log</span>

  <span class="c1"># 是否启用该类型，默认值为true。</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>

<span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">tcp</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">host</span><span class="p">:</span> <span class="s2">&quot;0.0.0.0:8888&quot;</span>
   
  <span class="c1"># 给数据打标签，会在顶级字段多出来多个标签</span>
  <span class="n">tags</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;linux&quot;</span><span class="p">]</span>

  <span class="c1"># 给数据添加KV类型的字段，默认放到fields字段中</span>
  <span class="n">fields</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">tomcat</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">productor</span>
  <span class="c1"># 若设置魏true，则自定义的字段放在顶级字段中，默认为fasle</span>
  <span class="n">fields_under_root</span><span class="p">:</span> <span class="n">true</span>

  <span class="c1"># 定义处理器，过滤指定的数据</span>
  <span class="n">processors</span><span class="p">:</span>
  <span class="c1"># 删除已INFO开头  的数据</span>
  <span class="o">-</span> <span class="n">drop_event</span><span class="p">:</span>
      <span class="n">when</span><span class="p">:</span>
        <span class="n">regexp</span><span class="p">:</span>
          <span class="n">message</span><span class="p">:</span> <span class="s2">&quot;^INFO&quot;</span>

  <span class="c1"># 消息包含error内容事件(event)就可以删除自定义字段或者tags。无法删除内置的字段.</span>
  <span class="o">-</span> <span class="n">drop_fields</span><span class="p">:</span>
      <span class="n">when</span><span class="p">:</span>
        <span class="n">contains</span><span class="p">:</span>
          <span class="n">message</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span>
      <span class="n">fields</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">]</span>
      <span class="n">ignore_missing</span><span class="p">:</span> <span class="n">false</span>

  <span class="c1"># 修改字段名</span>
  <span class="o">-</span> <span class="n">rename</span><span class="p">:</span>
      <span class="n">fields</span><span class="p">:</span>
        <span class="c1"># 原字段</span>
        <span class="o">-</span> <span class="n">from</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span>
          <span class="c1"># 目标字段</span>
          <span class="n">to</span><span class="p">:</span> <span class="s2">&quot;日志&quot;</span>
      
        <span class="o">-</span> <span class="n">from</span><span class="p">:</span> <span class="s2">&quot;message&quot;</span>
          <span class="n">to</span><span class="p">:</span> <span class="s2">&quot;消息&quot;</span>

  <span class="c1"># 转换数据,将字段的类型转换对应的数据类型，并存放在指定的字段中,本案例将其放在&quot;client&quot;字段中</span>
  <span class="o">-</span> <span class="n">convert</span><span class="p">:</span>
      <span class="n">fields</span><span class="p">:</span>
        <span class="o">-</span> <span class="p">{</span><span class="n">from</span><span class="p">:</span> <span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="s2">&quot;client.app&quot;</span> <span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">}</span>

<span class="c1"># 指定filebeat的输出端为console</span>
<span class="n">output</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
  <span class="c1"># 表示输出的内容以漂亮的格式显示</span>
  <span class="n">pretty</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
</section>
<section id="nginx">
<h4><span class="section-number">3.2.1.4. </span>采集Nginx日志<a class="headerlink" href="#nginx" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>配置nginx使用json格式的日志,重启nginx</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># vim /etc/nginx/nginx.conf </span>
    <span class="o">...</span>
    <span class="n">log_format</span> <span class="n">json</span> <span class="s1">&#39;{&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#39;</span>
                              <span class="s1">&#39;&quot;host&quot;:&quot;$server_addr&quot;,&#39;</span>
                              <span class="s1">&#39;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#39;</span>
                              <span class="s1">&#39;&quot;SendBytes&quot;:$body_bytes_sent,&#39;</span>
                              <span class="s1">&#39;&quot;responsetime&quot;:$request_time,&#39;</span>
                              <span class="s1">&#39;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#39;</span>
                              <span class="s1">&#39;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#39;</span>
                              <span class="s1">&#39;&quot;http_host&quot;:&quot;$host&quot;,&#39;</span>
                              <span class="s1">&#39;&quot;uri&quot;:&quot;$uri&quot;,&#39;</span>
                              <span class="s1">&#39;&quot;domain&quot;:&quot;$host&quot;,&#39;</span>
                              <span class="s1">&#39;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#39;</span>
                              <span class="s1">&#39;&quot;referer&quot;:&quot;$http_referer&quot;,&#39;</span>
                              <span class="s1">&#39;&quot;tcp_xff&quot;:&quot;$proxy_protocol_addr&quot;,&#39;</span>
                              <span class="s1">&#39;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#39;</span>
                              <span class="s1">&#39;&quot;status&quot;:&quot;$status&quot;}&#39;</span><span class="p">;</span>

    <span class="n">access_log</span>  <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">access</span><span class="o">.</span><span class="n">log</span>  <span class="n">json</span><span class="p">;</span>
    <span class="o">...</span>
</pre></div>
</div>
<ul class="simple">
<li><p>编写filebeat配置文件</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filebeat</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
<span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">log</span>
  <span class="n">paths</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">access</span><span class="o">.</span><span class="n">log</span><span class="o">*</span>
  <span class="n">json</span><span class="o">.</span><span class="n">keys_under_root</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">json</span><span class="o">.</span><span class="n">add_error_key</span><span class="p">:</span> <span class="n">true</span>

<span class="n">output</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
  <span class="c1"># 表示输出的内容以漂亮的格式显示</span>
  <span class="n">pretty</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
</section>
<section id="tomcat">
<h4><span class="section-number">3.2.1.5. </span>采集Tomcat日志<a class="headerlink" href="#tomcat" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>配置tomcat 日志格式</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vim</span> <span class="n">conf</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">xml</span> 
        <span class="o">&lt;</span><span class="n">Valve</span> <span class="n">className</span><span class="o">=</span><span class="s2">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="n">directory</span><span class="o">=</span><span class="s2">&quot;logs&quot;</span>
            <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;tomcat_access_log&quot;</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.txt&quot;</span>
<span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;{&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;,&amp;quot;authenticated&amp;quot;:&amp;quot;</span><span class="si">%u</span><span class="s2">&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;request&amp;quot;:&amp;quot;</span><span class="si">%r</span><span class="s2">&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;</span><span class="si">%s</span><span class="s2">&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%</span><span class="si">{Referer}</span><span class="s2">i&amp;quot;,&amp;quot;http_user_agent&amp;quot;:&amp;quot;%{User-Agent}i&amp;quot;}&quot;</span><span class="o">/&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>编写filebeat配置文件，采集访问日志</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filebeat</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
<span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">log</span>
  <span class="n">paths</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">apache</span><span class="o">-</span><span class="n">tomcat</span><span class="o">-</span><span class="mf">9.0.88</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">tomcat_access_log</span><span class="o">.*.</span><span class="n">txt</span>
  <span class="n">json</span><span class="o">.</span><span class="n">keys_under_root</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">json</span><span class="o">.</span><span class="n">add_error_key</span><span class="p">:</span> <span class="n">true</span>

<span class="n">output</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
  <span class="c1"># 表示输出的内容以漂亮的格式显示</span>
  <span class="n">pretty</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<ul class="simple">
<li><p>编写filebeat配置文件，采集错误日志</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">filebeat</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
<span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">log</span>
  <span class="n">paths</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">apache</span><span class="o">-</span><span class="n">tomcat</span><span class="o">-</span><span class="mf">9.0.88</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">catalina</span><span class="o">*</span>
  <span class="n">multiline</span><span class="o">.</span><span class="n">type</span><span class="p">:</span> <span class="n">pattern</span>
  <span class="n">multiline</span><span class="o">.</span><span class="n">pattern</span><span class="p">:</span> <span class="s1">&#39;^\d</span><span class="si">{2}</span><span class="s1">&#39;</span>
  <span class="n">multiline</span><span class="o">.</span><span class="n">negate</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">multiline</span><span class="o">.</span><span class="n">match</span><span class="p">:</span> <span class="n">after</span>

<span class="n">output</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
  <span class="c1"># 表示输出的内容以漂亮的格式显示</span>
  <span class="n">pretty</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
</section>
</section>
<section id="ouput">
<h3><span class="section-number">3.2.2. </span>Ouput 插件<a class="headerlink" href="#ouput" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="../../index.html" class="btn btn-neutral float-left" title="&lt;no title&gt;" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../kubernetes.html" class="btn btn-neutral float-right" title="1. Kubernetes 基础" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2024, Deng You。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>